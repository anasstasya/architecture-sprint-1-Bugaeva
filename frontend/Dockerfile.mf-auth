# syntax=docker/dockerfile:1

FROM node:22-alpine AS build-stage

ENV NODE_ENV production
# poor man out-of-tree build for the Crippled NPM
WORKDIR /app
RUN --mount=type=bind,source=.,target=/src \
    --mount=type=tmpfs,target=/src/microfrontend/microfrontend-auth/node_modules \
    --mount=type=tmpfs,target=/src/microfrontend/microfrontend-auth/dist \
<<EOF
set -e
cd /src/microfrontend/microfrontend-auth
npm install --include dev --include prod --no-fund --no-audit --no-save
# currently the behavior of production and development builds differ for unknown reasons
npm run build:dev
cp -pr dist/ /app
EOF

FROM nginxinc/nginx-unprivileged:1-alpine-slim AS production-stage
COPY --from=build-stage /app/dist /usr/share/nginx/html
